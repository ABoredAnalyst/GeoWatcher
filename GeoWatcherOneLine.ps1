Add-Type -AssemblyName System.Device; $GeoLocator = New-Object System.Device.Location.GeoCoordinateWatcher; $TimeoutSeconds = 5; $StartTime = Get-Date; Write-Host "Starting location locator. Waiting up to $TimeoutSeconds seconds for coordinates..."; $GeoLocator.Start(); $IsReady = $false; while ((Get-Date) -le ($StartTime).AddSeconds($TimeoutSeconds)) { if ($GeoLocator.Status -eq 'Ready') { $IsReady = $true; break } if ($GeoLocator.Permission -eq 'Denied') { Write-Error 'Location access permission was explicitly denied by the system or user.'; exit 1 } Start-Sleep -Milliseconds 250 }; $statusMap = @{ 'Disabled' = "Location access has been disabled in system settings."; 'NotInitialized' = "Location provider is initializing."; 'NoData' = "Location provider is not returning data."; 'Unknown' = "Location status is unknown."; 'Denied' = "Location access was explicitly denied by the user/system." }; if (-not $IsReady) { $currentStatus = $GeoLocator.Status; $errorMessage = $statusMap[$currentStatus]; if (-not $errorMessage) { $errorMessage = "Timed out waiting for GPS coordinates. Status: $currentStatus" }; Write-Warning $errorMessage } elseif ($GeoLocator.Permission -eq 'Denied') { Write-Error 'Location access permission was denied.' } else { $location = $GeoLocator.Position.Location; if ($location -ne $null -and $location.IsUnknown -eq $false) { $latitude = $location.Latitude; $longitude = $location.Longitude; $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"; Write-Host "Coordinates found: Lat $latitude, Lon $longitude"; try { $nominatimUrl = "https://nominatim.openstreetmap.org/reverse?format=json&lat=$latitude&lon=$longitude"; $headers = @{'User-Agent' = 'PowerShell Script (Personal Use)'}; $locationData = Invoke-RestMethod -Uri $nominatimUrl -Headers $headers -ErrorAction Stop; $locationName = $locationData.display_name; $googleMapsUrl = "https://www.google.com/maps?q=$latitude,$longitude"; [PSCustomObject]@{ Timestamp = $timestamp; Latitude = $latitude; Longitude = $longitude; GoogleMapsLink = $googleMapsUrl; ResolvedAddress = $locationName } | Write-Output } catch { Write-Warning "Could not resolve address via Nominatim API. Error: $($_.Exception.Message)"; [PSCustomObject]@{ Timestamp = $timestamp; Latitude = $latitude; Longitude = $longitude; GoogleMapsLink = "https://www.google.com/maps?q=$latitude,$longitude"; ResolvedAddress = "Address resolution failed (API error)." } | Write-Output } } else { Write-Warning 'GPS coordinates could not be resolved or are unknown.' } }; $GeoLocator.Stop()
